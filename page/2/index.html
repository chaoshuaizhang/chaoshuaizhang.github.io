<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="知识体系树">
<meta property="og:type" content="website">
<meta property="og:title" content="changePosition">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="changePosition">
<meta property="og:description" content="知识体系树">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="changePosition">
<meta name="twitter:description" content="知识体系树">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/">





  <title>changePosition</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">changePosition</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/14/spring/SOA 学习笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="changePosition">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="changePosition">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/14/spring/SOA 学习笔记/" itemprop="url">SOA 学习笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-14T13:43:05+08:00">
                2018-09-14
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/spring/" itemprop="url" rel="index">
                    <span itemprop="name">spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="SOA-学习笔记"><a href="#SOA-学习笔记" class="headerlink" title="SOA 学习笔记"></a>SOA 学习笔记</h2><h3 id="SOA项目搭建篇"><a href="#SOA项目搭建篇" class="headerlink" title="SOA项目搭建篇"></a>SOA项目搭建篇</h3><p><strong>主要目标是：完全清楚为什么要这么搭建，如何体现解耦、复用</strong></p>
<ol>
<li>大致的继承关系</li>
</ol>
<p><img src="/2018/09/14/spring/SOA 学习笔记/./1534138305704.png" alt="Alt text"></p>
<ul>
<li><p>SOATopPom</p>
<blockquote>
<p>dependency parent是spring-boot-starter-parent<br>最基础的项目只包含一个pom.xml文件，里边主要是：<br>1、第三方的依赖<br>2、伺服地址配置<br>3、部署构件配置<br>4、对于SP项目来说，spring-boot-starter等aop、web包没有包含在这个pom.xml文件中</p>
</blockquote>
</li>
<li><p>SOAParent</p>
<blockquote>
<p>SOAParent是聚合项目（一个prj包含多个module）<br>主项目也只包含一个pom.xml文件，里边是业务层所需的依赖<br>module：<br>  IService - jar：只写具体的接口，不写实现<br>  bean - jar<br>  dao - jar</p>
</blockquote>
</li>
<li><p>SOAProvider</p>
<blockquote>
<p>dependency parent为SOAParent，主要作用是实现IService，规范的情况下，provider中只有serviceImpl，并把实现了的service注册到zookeeper</p>
</blockquote>
</li>
<li><p>SOAConsumer</p>
<blockquote>
<p>consumer的dependency parent不需要为SOAParent（正常情况下消费者是与后台无关的，除非是一个系统既是consumer，又是provider），它只要引入对应的IService就行。</p>
</blockquote>
</li>
</ul>
<h3 id="Dubbo篇"><a href="#Dubbo篇" class="headerlink" title="Dubbo篇"></a>Dubbo篇</h3><h3 id="zookeeper篇"><a href="#zookeeper篇" class="headerlink" title="zookeeper篇"></a>zookeeper篇</h3><ol>
<li><p>zookeeper默认的三个端口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//对client端提供服务，在provider和consumer中设置registry时使用</span></span><br><span class="line"><span class="number">2181</span></span><br><span class="line"><span class="comment">//服务器与集群中的 Leader 服务器交换信息的端口</span></span><br><span class="line"><span class="number">2888</span></span><br><span class="line"><span class="comment">//一旦集群中的 Leader 服务器挂了，需要一个端口重新进行选举，选出一个新的 Leader</span></span><br><span class="line"><span class="number">3888</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>application.properties中spring-dubbo的配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//应用名称</span></span><br><span class="line">spring.dubbo.application.name=dubbo_consumer</span><br><span class="line"><span class="comment">//注册中心地址</span></span><br><span class="line"><span class="comment">//两台服务器，三个zookeeper注册中心（算是伪集群）</span></span><br><span class="line">spring.dubbo.registry.address=zookeeper:<span class="comment">//172.16.103.146:2281?backup=172.16.103.19:2281,172.16.103.136:2381</span></span><br><span class="line"><span class="comment">//协议名称</span></span><br><span class="line">spring.dubbo.protocol.name=dubbo</span><br><span class="line"><span class="comment">//协议端口</span></span><br><span class="line">spring.dubbo.protocol.port=<span class="number">20800</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">spring.dubbo.registry.timeout=<span class="number">6000</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Dubbo-Admin搭建"><a href="#Dubbo-Admin搭建" class="headerlink" title="Dubbo-Admin搭建"></a>Dubbo-Admin搭建</h3><ol start="2">
<li>出现的问题<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. It is probably not running</span><br><span class="line">	删除data下面除myid之外的其它文件</span><br><span class="line">	保证dataDir、dataDirLog的路径是正确的</span><br><span class="line"><span class="number">2</span>. 实验证明，当provider写了版本号后，consumer必须也要写版本号，不然引不到</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<blockquote>
<p>后台学习推荐书籍<br>spring in action 第四版<br>springboot 揭秘  配合博客<br>dubbo 官网<br>《大型网站技术架构：核心原理与案例分析》<br>《大型网站系统与Java中间件实践》<br>大型分布式网站架构设计与实践<br>SOA理解<br>redis<br>redis开发与运维</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/27/thread/线程池的饱和策略/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="changePosition">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="changePosition">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/27/thread/线程池的饱和策略/" itemprop="url">线程池的饱和策略</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-27T17:46:29+08:00">
                2018-06-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="线程池的饱和策略"><a href="#线程池的饱和策略" class="headerlink" title="线程池的饱和策略"></a>线程池的饱和策略</h2><p>@(java)</p>
<blockquote>
<p>当没有更多线程或队列槽可用时，或者因为超出它们的边界，或者在关闭Executor时，ThreadPoolExecutor.execute无法接受任务时，ThreadPoolExecutor会调用rejectedExecution这个方法。<br>什么时候会出现？</p>
<blockquote>
<ul>
<li>AbortPolicy：默认的饱和策略，对于队列满了的情况，会直接抛出异常。</li>
<li>CallerRunsPolicy：会拒绝无法执行（线程队列满了）的线程，线程被拒绝执行后，会交给调用线程来执行。</li>
<li></li>
</ul>
</blockquote>
</blockquote>
<h5 id="主要实现RejectedExecutionHandler接口"><a href="#主要实现RejectedExecutionHandler接口" class="headerlink" title="主要实现RejectedExecutionHandler接口"></a>主要实现RejectedExecutionHandler接口</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当&#123;<span class="doctag">@link</span> ThreadPoolExecutor #execute execute&#125;无法接受任务</span></span><br><span class="line"><span class="comment">     * 时，会调用这个方法。 当没有更多线程或队列槽可用时，或者因为超出它们</span></span><br><span class="line"><span class="comment">     * 的边界，或者在关闭Executor时，可能会发生这种情况。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor executor)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="现类"><a href="#现类" class="headerlink" title="现类"></a>现类</h5><h6 id="AbortPolicy"><a href="#AbortPolicy" class="headerlink" title="AbortPolicy"></a>AbortPolicy</h6><blockquote>
<p>默认的Handler</p>
<ol>
<li>队列满-抛异常</li>
<li>但队列中的任务继续执行</li>
<li>之后即使队列为空，仍不会再往队列中放数据了（因为已经抛异常了）<br><strong>线程数为3，队列为5，则最少可执行8个任务。</strong>三个任务直接执行，其余5个放队列。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 当队列满了时，通过直接抛出异常来解决饱和问题，但</span></span><br><span class="line"><span class="comment"> * 是队列中的任务会继续执行，直到执行完成。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//注意这里是主线程，当其他线程无法执行时，会进入到这里，如果执行r.run()则继续执行，但线程是主线程了</span></span><br><span class="line">	<span class="comment">//System.out.println(Thread.currentThread().getName());</span></span><br><span class="line">	<span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException(<span class="string">"Task "</span> + r.toString() +</span><br><span class="line">										 <span class="string">" rejected from "</span> +</span><br><span class="line">										 e.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    executor.execute(() -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">"my run ... 1 "</span> + Thread.currentThread().getName());</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        System.out.println(<span class="string">"-----OVER-----"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//输出结果</span></span><br><span class="line">my run ... <span class="number">1</span> pool-<span class="number">1</span>-thread-<span class="number">1</span></span><br><span class="line">Exception in thread <span class="string">"main"</span> java.util.concurrent.RejectedExecutionException: ......</span><br><span class="line">-----OVER-----</span><br><span class="line">my run ... <span class="number">1</span> pool-<span class="number">1</span>-thread-<span class="number">1</span></span><br><span class="line">-----OVER-----</span><br></pre></td></tr></table></figure>
<blockquote>
<ol>
<li>对上述的输出结果有些诧异，因为只有一个线程，为什么会有两个完整的执行体（打印出OVER说明线程执行体执行完成）？</li>
<li>执行两次的原因不清楚，为什么会执行两次？只有一个线程容量，加入第二个任务时应该直接抛异常吧，为什么是执行完第二个任务后才抛异常？<blockquote>
<p><strong>这个容量满了是指当前的线程池以及其缓冲队列的容量都满了才是满了, 而不是线程池的数量。先勉强用这个解释吧，但我看代码仍没看出来！</strong>应该就是这个原因，如果把线程数设置为1，但Queue设置为10，则会先执行一个任务，然后把其余任务加入到队列，如果队列满了，并且没有空闲线程。</p>
</blockquote>
</li>
</ol>
</blockquote>
<h6 id="DiscardPolicy"><a href="#DiscardPolicy" class="headerlink" title="DiscardPolicy"></a>DiscardPolicy</h6><blockquote>
<p>丢弃策略</p>
<ol>
<li>队列满时，丢掉待入队的任务，直到队列有空闲，才加入任务。</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//线程数不够，或者executor关闭时，执行</span></span><br><span class="line">	<span class="comment">//此处的空方法表示什么都不执行，即对于那些无法处理的线程不进行任何处理---即丢弃</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="CallerRunsPolicy"><a href="#CallerRunsPolicy" class="headerlink" title="CallerRunsPolicy"></a>CallerRunsPolicy</h6><blockquote>
<p>当线程池没有资源，队列满了时，无法执行的task会<strong>交给调用线程（开启线程池的那个线程）执行。</strong><br>比如有10个任务，3个线程，队列为3，则：<br>1-3三个任务由线程直接执行。<br>4-6三个任务放进队列<br>第7个任务会根据情况，如果没有空闲线程，队列不空闲，则交由调用线程执行</p>
</blockquote>
<p><strong>rejectedExecution执行体</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!e.isShutdown()) &#123;</span><br><span class="line">	    <span class="comment">//注意看：这里执行了r.run()，请问是哪个线程执行的？</span></span><br><span class="line">	    <span class="comment">//分析下：主线程开启了线程池来执行任务，而当前的方法是在线程调度的过程中发生的</span></span><br><span class="line">	    <span class="comment">//那么谁来进行线程调度？主线程。</span></span><br><span class="line">	    <span class="comment">//所以r.run()也是在main线程池中执行的。</span></span><br><span class="line">        r.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>例子</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    executor.execute(() -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">"my run ... 1 "</span> + Thread.currentThread().getName());</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h6 id="DiscardOldestPolicy"><a href="#DiscardOldestPolicy" class="headerlink" title="DiscardOldestPolicy"></a>DiscardOldestPolicy</h6><blockquote>
<p>移除（丢弃不执行）最老（队头）的task，执行新插入的task</p>
</blockquote>
<p><strong>rejectedExecution实现</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!e.isShutdown()) &#123;</span><br><span class="line">	    <span class="comment">//出队</span></span><br><span class="line">        e.getQueue().poll();</span><br><span class="line">        <span class="comment">//由线程池执行新入队的线程</span></span><br><span class="line">        e.execute(r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h6 id="自定义RejectedExecutionHandler"><a href="#自定义RejectedExecutionHandler" class="headerlink" title="自定义RejectedExecutionHandler"></a>自定义RejectedExecutionHandler</h6><blockquote>
<p>当上述四种策略都无法满足时，可以自定义饱和策略。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span> <span class="keyword">implements</span> <span class="title">RejectedExecutionHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor executor)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//r.run();</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException(<span class="string">"异常信息"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/09/java/AOP的一些使用与理解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="changePosition">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="changePosition">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/09/java/AOP的一些使用与理解/" itemprop="url">AOP的一些使用与理解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-09T23:56:01+08:00">
                2018-06-09
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h1><p>[TOC]</p>
<blockquote>
<ul>
<li>OOP作用：日志记录，权限验证，事务控制，性能检测，错误信息检测等等，和核心业务没有任何关系。</li>
<li>为什么要使用切面编程：方便，提取公共的非业务代码，避免一些逻辑校验代码与业务代码混合，可以使用分层思想，从上到下，一个一个的切面，剥离一些“无用”的代码，直到抽出核心代码。</li>
</ul>
</blockquote>
<blockquote>
<p>AOP-AspectJ-SpringAOP-JDK动态代理-CGlib动态代理这几个的关系<br><img src="/2018/06/09/java/AOP的一些使用与理解/./67c610db84fdb4a7d346f0a5d181ca23.png" alt="Alt text"></p>
</blockquote>
<h3 id="实现切面的两种思路"><a href="#实现切面的两种思路" class="headerlink" title="实现切面的两种思路"></a>实现切面的两种思路</h3><h4 id="横向扩展"><a href="#横向扩展" class="headerlink" title="横向扩展"></a>横向扩展</h4><ul>
<li>AspectJ</li>
<li>代理</li>
</ul>
<h4 id="纵向扩展"><a href="#纵向扩展" class="headerlink" title="纵向扩展"></a>纵向扩展</h4><blockquote>
<p>一般通过继承的方式：A要有个大日志的功能，则B继承A，B重写A的方法，添加日志，A又想有监测的功能，则C继承B，重写B的方法，添加监测功能。</p>
</blockquote>
<p>缺点：如上所述，添加的功能越多，代码耦合越大。</p>
<h3 id="AspectJ分析"><a href="#AspectJ分析" class="headerlink" title="AspectJ分析"></a>AspectJ分析</h3><blockquote>
<p>分为两种：</p>
<ul>
<li>基于AspectJ语法编写，然后使用ajc（默认java使用的是javac，因为要编译AspectJ，需要在IDE中改成ajc，或者是使用命令，依赖于aspectjtool包）编译.aj文件，生成标准的class文件。</li>
<li>基于注解，Java语言+aspectj包的注解，通过AspectJ提供的编织器，编织代码到目标class文件中（<strong>但是我反编译class文件，没有看到被织入的代码</strong>）。</li>
</ul>
</blockquote>
<h5 id="织入的概念"><a href="#织入的概念" class="headerlink" title="织入的概念"></a>织入的概念</h5><blockquote>
<p>何为织入？使切面的逻辑代码并入（逻辑上并入或者物理上并入）到业务代码中，这里的逻辑和物理是指：A中调用B称为逻辑织入，A和B融合到一起称为物理织入。</p>
</blockquote>
<ul>
<li>如何织入？两种方式吧（<a href="https://blog.mythsman.com/2017/12/21/1/" target="_blank" rel="noopener">参考网络</a>）</li>
</ul>
<ol>
<li>提供注册机制，通过提供配置文件（注册表）指明那些类需要被切。（<strong>逻辑织入</strong>）</li>
<li>在编译期或者类加载期，优先编译或加载切面代码，然后将切面代码并入到指定的类中，一般都是通过aspectjweaver包实现的。（<strong>物理织入</strong>）</li>
</ol>
<blockquote>
<p>总感觉这两种方式差不多吧，难道第一种是我使用某一个方法时，先查一下它是否进行了切面注册，如果是的话，先执行切面？第二种就是我常用的方式。</p>
</blockquote>
<h5 id="物理织入"><a href="#物理织入" class="headerlink" title="物理织入"></a>物理织入</h5><blockquote>
<p><strong>具体分为三种</strong></p>
<blockquote>
<p>使用AspectJ语法的话，默认只能使用第一种方式（因为.aj文件只能通过ajc编译），使用注解的话，下列三种方式都可以实现。</p>
<ol>
<li>编译时织入<br>利用<strong>ajc编译器替代javac编译器</strong>，直接将源文件(java或者aspect文件)编译成class文件并将切面织入进代码。</li>
<li>编译后织入<br>利用ajc编译器<strong>向javac编译期编译后的</strong>class文件或jar文件织入切面代码。</li>
<li>加载时织入<br><strong>不使用ajc编译器</strong>，利用aspectjweaver.jar工具，使用java agent代理在类加载期将切面织入进代码。</li>
</ol>
</blockquote>
</blockquote>
<p><img src="/2018/06/09/java/AOP的一些使用与理解/./8acf8e36d6042f9459df05007a3c803c.png" alt="Alt text"></p>
<h4 id="第一种、使用AspectJ语法"><a href="#第一种、使用AspectJ语法" class="headerlink" title="第一种、使用AspectJ语法"></a>第一种、使用AspectJ语法</h4><blockquote>
<p>这种方式只需借助<code>aspectjrt.jar、aspectjtools.jar这两个jar包</code></p>
</blockquote>
<h5 id="使用原生AspectJ语法定义切面"><a href="#使用原生AspectJ语法定义切面" class="headerlink" title="使用原生AspectJ语法定义切面"></a>使用原生AspectJ语法定义切面</h5><blockquote>
<p>此文件为TestAspect.aj文件，默认IDE是不能创建.aj文件的，添加spring-aop依赖后就可以创建。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> aspect TestAspect &#123;</span><br><span class="line">    <span class="comment">//定义切点</span></span><br><span class="line">    <span class="function">pointcut <span class="title">webLog</span><span class="params">()</span>: <span class="title">execution</span><span class="params">(<span class="keyword">public</span> * net.shopin.pdaware.common..*.sayHello(..)</span>)</span>;</span><br><span class="line">    <span class="comment">//前置通知</span></span><br><span class="line">    before(): webLog() &#123;</span><br><span class="line">        System.out.println(<span class="string">"前置 入参打印"</span> + thisJoinPoint.getArgs());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//环绕通知</span></span><br><span class="line">    around(): webLog()&#123;</span><br><span class="line">        System.out.println(<span class="string">"环绕打印"</span>);</span><br><span class="line">        <span class="comment">//获得参数名</span></span><br><span class="line">        String[] names = ((CodeSignature) thisJoinPointStaticPart.getSignature()).getParameterNames();</span><br><span class="line">        <span class="comment">//获得参数</span></span><br><span class="line">        Object[] args = thisJoinPoint.getArgs();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//后置通知</span></span><br><span class="line">    after(): webLog(JoinPoint point)&#123;</span><br><span class="line">        System.out.println(<span class="string">"后置 返参打印"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="织入后的文件"><a href="#织入后的文件" class="headerlink" title="织入后的文件"></a>织入后的文件</h5><blockquote>
<p>首先，我没有看到织入成功的文件，配置了ajc但是没生效，所以拷贝一段网络的代码吧。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//前置通知</span></span><br><span class="line">		TestAspect.aspectOf().ajc$before$TestAspect$<span class="number">1</span>$<span class="number">682722</span>c();</span><br><span class="line">		<span class="comment">//核心业务代码</span></span><br><span class="line">		System.out.println(<span class="string">"Hello"</span>);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Throwable localThrowable) &#123;</span><br><span class="line">		<span class="comment">//后置通知（不清楚为什么这里也有后置通知）</span></span><br><span class="line">		TestAspect.aspectOf().ajc$after$TestAspect$<span class="number">2</span>$<span class="number">682722</span>c();</span><br><span class="line">		<span class="keyword">throw</span> localThrowable;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//明明这里有一个后置通知就行了，为什么上边的catch中还会有一个？</span></span><br><span class="line">	TestAspect.aspectOf().ajc$after$TestAspect$<span class="number">2</span>$<span class="number">682722</span>c();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="编译后的Aspect文件"><a href="#编译后的Aspect文件" class="headerlink" title="编译后的Aspect文件"></a>编译后的Aspect文件</h5><ul>
<li><p>看到上述的前置后置都是调用TestAspect.aspectOf().XXX来实现打日志，可以联想到可能是个单例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TestAspect <span class="title">aspectOf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(ajc$perSingletonInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> NoAspectBoundException(<span class="string">"TestAspect"</span>, ajc$initFailureCause);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ajc$perSingletonInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>什么时候初始化perSingletonInstance呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//静态代码块，类加载时就先初始化</span></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//实例化我们定义的切面对象</span></span><br><span class="line">		ajc$postClinit();</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Throwable localThrowable) &#123;</span><br><span class="line">		ajc$initFailureCause = localThrowable;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> ajc$postClinit() &#123;</span><br><span class="line">	<span class="comment">//可以看到在这里实例化了一个TestAspect对象</span></span><br><span class="line">	ajc$perSingletonInstance = <span class="keyword">new</span> TestAspect();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过单例来调用前置、后置、环绕等方法<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> ajc$before$TestAspect$<span class="number">1</span>$<span class="number">682722</span>c() &#123;</span><br><span class="line">	System.out.println(<span class="string">"前置 入参打印"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> ajc$after$TestAspect$<span class="number">2</span>$<span class="number">682722</span>c() &#123;</span><br><span class="line">	System.out.println(<span class="string">"后置 返参打印"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>通过看上边.aj文件的编译情况，可以想到为什么说AspectJ是静态编译了，他就是把在核心业务代码前后调用了一些方法，和我们手动定义一些Util方法是有些类似的，不同的是，这些AspectJ会自动为我们做好。<br>缺点：</p>
</blockquote>
<h4 id="第二种、使用注解"><a href="#第二种、使用注解" class="headerlink" title="第二种、使用注解"></a>第二种、使用注解</h4><blockquote>
<p>这种方式不仅需要借助<code>aspectjrt.jar、aspectjtools.jar这两个jar包</code>还需要<code>aspectjweaver.jar</code>，因为注解的方式需要把目标class文件和切面class文件进行织入。aspectj语法的方式不需要aspectjweaver，不太清楚为什么不需要aspectweaver包，但肯定和它是.aj有关，哈哈。</p>
<blockquote>
<p>下面将讲三种方式：编译时、后、加载时。我从服务端down的class文件中没有织入代码，难道使用的是加载是的织入方式？不是的！Spring的aop借助的是【】</p>
</blockquote>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Order</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebLogAspect</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"execution(public * net.shopin.pdaware..*Controller.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">webLog</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"webLog()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doLogBefore</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="meta">@After</span>(<span class="string">"webLog()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doLogAfter</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="方式一、编译时织入"><a href="#方式一、编译时织入" class="headerlink" title="方式一、编译时织入"></a>方式一、编译时织入</h5><blockquote>
<p>所谓编译时织入就是：在使用ajc编译目标.java文件和切面文件时，就进行融合，生成的class文件和上述使用AspectJ语法编写后的织入是一样的。</p>
</blockquote>
<h5 id="方式二、编译后织入"><a href="#方式二、编译后织入" class="headerlink" title="方式二、编译后织入"></a>方式二、编译后织入</h5><blockquote>
<p>编译后织入分为两步。</p>
</blockquote>
<ul>
<li>第一步：使用javac编译目标文件和切面文件，生成.class（和java文件没有区别，看不出什么）。</li>
<li>第二步：使用ajc再次处理（编译？）上述class文件，得到新的织入切面代码后的class文件（此时看到的新的class文件和上述AspectJ语法编译后的class是一样的，单例模式）。</li>
</ul>
<hr>
<blockquote>
<p>上述两种aspect.class时如何织入到target.class文件中的？</p>
<blockquote>
<p>我们在<strong>aspect中定义的有我要切哪些目标类、方法等</strong>，所以编译期会通过这些标识去找到对应的target，然后织入。</p>
</blockquote>
</blockquote>
<h5 id="方式三、加载时织入（LTW）"><a href="#方式三、加载时织入（LTW）" class="headerlink" title="方式三、加载时织入（LTW）"></a>方式三、加载时织入（LTW）</h5><blockquote>
<p>LTW：Load-Time Weaving<br>此时就不借助于ajc工具了。</p>
</blockquote>
<h6 id="如何实现？"><a href="#如何实现？" class="headerlink" title="如何实现？"></a>如何实现？</h6><blockquote>
<p>上述已经说了，编译时、后是通过ajc查看class为标识把目标class和切面class进行关联，那么运行时呢？已经编译过了，咋关联？</p>
<blockquote>
<p>是否可以通过一种方式：在加载目标类时它知道它要被某个切面进行关联，所以JVM要先加载那个切面，然后再加载它自己。也就是在目标类加载之前，其对应的切面必须被加载完成。</p>
</blockquote>
</blockquote>
<p><strong>具体的织入方式需要借助于JavaAgent</strong></p>
<blockquote>
<p>对于javaagent这里就不做详细介绍了，毕竟不清楚。大致拷贝下它的作用</p>
</blockquote>
<ul>
<li>可以在加载 class 文件之前做拦截，对字节码做修改</li>
<li>可以在运行期对已加载类的字节码做变更，但是这种情况下会有很多的限制</li>
<li>还有其他一些小众的功能：<blockquote>
<ul>
<li>获取所有已经加载过的类</li>
<li>获取所有已经初始化过的类（执行过 clinit 方法，是上面的一个子集）</li>
<li>获取某个对象的大小</li>
<li>将某个 jar 加入到 bootstrap classpath 里作为高优先级被 bootstrapClassloader 加载</li>
<li>将某个 jar 加入到 classpath 里供 AppClassloard 去加载</li>
<li>设置某些 native 方法的前缀，主要在查找 native 方法的时候做规则匹配</li>
</ul>
</blockquote>
</li>
</ul>
<p><strong>从agent的作用可以看出来，它可以实现运行时的织入。</strong></p>
<h6 id="使用LTW方式的要求"><a href="#使用LTW方式的要求" class="headerlink" title="使用LTW方式的要求"></a>使用LTW方式的要求</h6><blockquote>
<p>官方给了三个要使用LTW的前置条件。</p>
<ol>
<li>All aspects to be used for weaving <strong>must be defined to the weaver before any types to be woven are loaded</strong>. This avoids types being “missed” by aspects added later, with the result that invariants across types fail.<br>在加载需要被织入切面的业务代码前，必须把所有的织入类先加载了。</li>
<li>All aspects visible to the weaver are usable. A visible aspect is one defined by the weaving class loader or one of its parent class loaders. All concrete visible aspects are woven and all abstract visible aspects may be extended.</li>
<li><strong>A class loader may only weave classes that it defines.</strong> It may not weave classes loaded by <strong>a delegate or parent class loader</strong>.<br>类加载器可能只会织入它定义（加载）的那些类。其它加载器、父加载器定义的类他可能无法织入。</li>
</ol>
</blockquote>
<h3 id="SpringAOP"><a href="#SpringAOP" class="headerlink" title="SpringAOP"></a>SpringAOP</h3><h5 id="疑惑点"><a href="#疑惑点" class="headerlink" title="疑惑点"></a>疑惑点</h5><blockquote>
<p>总是不清楚SpringAOP这个概念，都说实现方式是JDK动态代理或者是Cglib，但是我在Spring项目中使用的只是AspectJ，所以就一直在想AspectJ是不是也是SpringAOP的一种实现方式，毕竟SpringAOP也依赖了aspectjweaver的包。</p>
</blockquote>
<h6 id="pom中的依赖"><a href="#pom中的依赖" class="headerlink" title="pom中的依赖"></a>pom中的依赖</h6><blockquote>
<p>可以看到spring-aop中也是依赖aspectjweaver的，所以为啥它的实现方式只是代理而没有AspectJ呢？</p>
</blockquote>
<ul>
<li>spring-boot-starter-aop<br><img src="/2018/06/09/java/AOP的一些使用与理解/./de2ffb0b869b69dd743b870a970e2830.png" alt="Alt text"></li>
<li>spring-aop<br><img src="/2018/06/09/java/AOP的一些使用与理解/./eec369c68e59c64f7144db801613ed47.png" alt="Alt text"></li>
</ul>
<h5 id="如何判断你用的是织入方式还是代理方式"><a href="#如何判断你用的是织入方式还是代理方式" class="headerlink" title="如何判断你用的是织入方式还是代理方式"></a>如何判断你用的是织入方式还是代理方式</h5><blockquote>
<p>目前没有看出来，只能通过打印</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IAnimalEat target = (IAnimalEat) factory.getProxy();</span><br><span class="line">System.out.println(<span class="string">"生成的新的代理类："</span> + target.getClass().getName());</span><br></pre></td></tr></table></figure>
<ul>
<li>JDK<br><img src="/2018/06/09/java/AOP的一些使用与理解/./6121ca1a8f560bccbdab7df5bb0d8d61.png" alt="Alt text"></li>
<li>Cglib<br><img src="/2018/06/09/java/AOP的一些使用与理解/./4ad811775c2ba1fe9a2f72e7011385e6.png" alt="Alt text"></li>
</ul>
<h3 id="JDK动态代理原理"><a href="#JDK动态代理原理" class="headerlink" title="JDK动态代理原理"></a>JDK动态代理原理</h3><blockquote>
<p>直接看手写动态代理那块儿就行，重点是为什么非得要接口才能实现</p>
</blockquote>
<h3 id="Cglib代理原理"><a href="#Cglib代理原理" class="headerlink" title="Cglib代理原理"></a>Cglib代理原理</h3><h3 id="SpringAOP分析"><a href="#SpringAOP分析" class="headerlink" title="SpringAOP分析"></a>SpringAOP分析</h3><h4 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h4><blockquote>
<p>都直到是两种方式，什么有接口是jdk，没接口是jdk。</p>
</blockquote>
<h5 id="模板实例"><a href="#模板实例" class="headerlink" title="模板实例"></a>模板实例</h5><blockquote>
<p>先不用管这个实例会采用什么方式代理，先分析流程。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ProxyFactory factory = <span class="keyword">new</span> ProxyFactory();</span><br><span class="line">IAnimalEat dog = <span class="keyword">new</span> Dog();</span><br><span class="line"><span class="comment">//第一步：设置目标代理类</span></span><br><span class="line">factory.setTarget(dog);</span><br><span class="line"><span class="comment">//第二步：设置各种通知</span></span><br><span class="line">factory.addAdvice(<span class="keyword">new</span> BeforeAdvice());</span><br><span class="line">factory.addAdvice(<span class="keyword">new</span> AfterReturnAdvice());</span><br><span class="line"><span class="comment">//得到代理类（这块儿如果没有接口的话，就直接用实体类接受就行，不影响）</span></span><br><span class="line">IAnimalEat target = (IAnimalEat) factory.getProxy();</span><br><span class="line"><span class="comment">//执行业务方法</span></span><br><span class="line">target.eat();</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>有个简单的SpringAOP就实现了，当然可以对其进行封装，详见下边的参考文档。</p>
</blockquote>
<h6 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h6><blockquote>
<p>分析上述模板代码的执行流程。</p>
</blockquote>
<p><strong>从模板可以看出，核心方法应该是getProxy()，so我们先分析它。</strong></p>
<ul>
<li><p>ProxyFactory.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getProxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.createAopProxy().getProxy();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> AopProxy <span class="title">createAopProxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//getAopProxyFactory得到的就是一个DefaultAopProxyFactory()对象</span></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.getAopProxyFactory().createAopProxy(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>DefaultAopProxyFactory.java</p>
<blockquote>
<p>核心代码，可以看到具体使用jdk还是cglib全在这里进行判断</p>
</blockquote>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AopProxy <span class="title">createAopProxy</span><span class="params">(AdvisedSupport config)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//【1】此处成立则使用JDK代理</span></span><br><span class="line">	<span class="keyword">if</span> (!config.isOptimize() &amp;&amp; !config.isProxyTargetClass() &amp;&amp; !<span class="keyword">this</span>.hasNoUserSuppliedProxyInterfaces(config)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> JdkDynamicAopProxy(config);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		Class&lt;?&gt; targetClass = config.getTargetClass();</span><br><span class="line">		<span class="comment">//【3】判断targetClass是否是接口，是否是proxy的子类，都是的话用JDK代理，否则Cglib</span></span><br><span class="line">		<span class="keyword">return</span> (AopProxy)(!targetClass.isInterface() &amp;&amp; !Proxy.isProxyClass(targetClass) ? <span class="keyword">new</span> ObjenesisCglibAopProxy(config) : <span class="keyword">new</span> JdkDynamicAopProxy(config));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这个方法的cache这块儿不太懂</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isProxyClass</span><span class="params">(Class&lt;?&gt; cl)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> Proxy.class.isAssignableFrom(cl) &amp;&amp; proxyClassCache.containsValue(cl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasNoUserSuppliedProxyInterfaces</span><span class="params">(AdvisedSupport config)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//得到设置的接口类（要么有一个，要么没有）</span></span><br><span class="line">	Class&lt;?&gt;[] ifcs = config.getProxiedInterfaces();</span><br><span class="line">	<span class="comment">//【2】</span></span><br><span class="line">	<span class="keyword">return</span> ifcs.length == <span class="number">0</span> || ifcs.length == <span class="number">1</span> &amp;&amp; SpringProxy.class.isAssignableFrom(ifcs[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>【1】：config应该就是一个配置类，isOptimize默认是false，isProxyTargetClass默认也是false，但是这两个属性都提供了set方法供我们修改它的值。<br>【2】：hasNoUserSuppliedProxyInterfaces根据是否有接口、接口个数是不是1并且接口是不是SpringProxy类型，来返回true、false。</p>
<blockquote>
<p>先不管第三点，<strong>如果我们想用JDK代理，则需要保证</strong>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. Optimize = <span class="keyword">false</span><span class="comment">//是否对产生代理的策略进行优化</span></span><br><span class="line"><span class="number">2</span>. isProxyTargetClass = <span class="keyword">false</span><span class="comment">//设置代理的模式jdk/cglib</span></span><br><span class="line"><span class="number">3</span>. 设置了接口类，并且接口不继承自SpringProxy。</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>如何设置接口类？</p>
</blockquote>
<ul>
<li>AdvisedSupport.java<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt;[] getProxiedInterfaces() &#123;</span><br><span class="line">	<span class="comment">//interfaces是一个list对象</span></span><br><span class="line">	<span class="keyword">return</span> (Class[])<span class="keyword">this</span>.interfaces.toArray(<span class="keyword">new</span> Class[<span class="keyword">this</span>.interfaces.size()]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>看一下interfaces是在哪赋值的？</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInterfaces</span><span class="params">(Class... interfaces)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.interfaces.clear();</span><br><span class="line">	Class[] var2 = interfaces;</span><br><span class="line">	<span class="keyword">int</span> var3 = interfaces.length;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> var4 = <span class="number">0</span>; var4 &lt; var3; ++var4) &#123;</span><br><span class="line">		Class&lt;?&gt; ifc = var2[var4];</span><br><span class="line">		<span class="comment">//调用addInterface方法，往上述的interfaces里添加接口类</span></span><br><span class="line">		<span class="keyword">this</span>.addInterface(ifc);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterface</span><span class="params">(Class&lt;?&gt; intf)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">this</span>.interfaces.contains(intf)) &#123;</span><br><span class="line">		<span class="keyword">this</span>.interfaces.add(intf);</span><br><span class="line">		<span class="keyword">this</span>.adviceChanged();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>OK，只要设置setInterfaces就行，我们发现<strong>ProxyFactory继承自ProxyCreatorSupport，ProxyCreatorSupport继承自AdvisedSupport</strong>。<br>所以上述的三点可以改为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. Optimize = <span class="keyword">false</span><span class="comment">//是否对产生代理的策略进行优化</span></span><br><span class="line"><span class="number">2</span>. isProxyTargetClass = <span class="keyword">false</span><span class="comment">//设置代理的模式jdk/cglib</span></span><br><span class="line"><span class="number">3</span>. 设置setInterfaces，并且接口不继承自SpringProxy。</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>同时发现设置优化时才会有机会使用Cglib，难道Cglib性能更好？（Cglib：创建慢，执行块，JDK：创建快，执行慢）。</p>
<ul>
<li>所以，最终如果想使用JDK，则需要把模板修改为：</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">factory.setTarget(dog);</span><br><span class="line">factory.setProxyTargetClass(<span class="keyword">false</span>);<span class="comment">//默认false，可不设置</span></span><br><span class="line">factory.setOptimize(<span class="keyword">false</span>);<span class="comment">//默认false，可不设置</span></span><br><span class="line">factory.setInterfaces(IAnimalEat.class);<span class="comment">//设置目标类的接口</span></span><br><span class="line">factory.addAdvice(<span class="keyword">new</span> BeforeAdvice());</span><br><span class="line">factory.addAdvice(<span class="keyword">new</span> AfterReturnAdvice());</span><br><span class="line">IAnimalEat target = (IAnimalEat) factory.getProxy();</span><br></pre></td></tr></table></figure>
<ul>
<li><p>运行：<br><img src="/2018/06/09/java/AOP的一些使用与理解/./b1b1ed687d431b10051a5c88bcf30d5a.png" alt="Alt text"></p>
</li>
<li><p>如果我们想使用Cglib代理呢？</p>
<blockquote>
<p><strong>必要不充分条件</strong>：上述的三个条件只要有一个不成立就行。<br>忘记了还有一个重要的判断呢。</p>
</blockquote>
</li>
</ul>
<p>【3】：判断targetClass是否是接口类型，是否继承proxy等</p>
<ul>
<li>我们自己定义的代理类不可能是接口，并且一般不会继承自Proxy类，所以当逻辑走到了这里，并且代理类是我们自己定义的时候，一般就会使用Cglib代理。</li>
</ul>
<h4 id="Cglib和JDK比较"><a href="#Cglib和JDK比较" class="headerlink" title="Cglib和JDK比较"></a>Cglib和JDK比较</h4><blockquote>
<p>性能问题：由于Cglib代理是利用ASM字节码生成框架<strong>在内存中生成一个需要被代理类的子类完成代理</strong>，而JDK动态代理是<strong>利用反射</strong>原理完成动态代理，所以Cglib创建的动态代理对象性能比JDk动态代理动态创建出来的代理对象新能要好的多，但是对象创建的速度比JDk动态代理要慢，所以，当Spring使用的是单例情况下可以选用Cglib代理，反之使用JDK动态代理更加合适。同时还有一个问题，被final修饰的类只能使用JDK动态代理，因为被final修饰的类不能被继承，而Cglib则是利用的继承原理实现代理的。<a href="https://my.oschina.net/zicheng/blog/1920892" target="_blank" rel="noopener">摘自</a></p>
</blockquote>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://mp.weixin.qq.com/s/V3v3uit9pLyGU-eO9VyArg" target="_blank" rel="noopener">文章</a><br><a href="https://www.eclipse.org/aspectj/doc/released/devguide/ltw.html" target="_blank" rel="noopener">LTW</a><br><a href="https://www.infoq.cn/article/javaagent-illustrated" target="_blank" rel="noopener">JavaAgent</a><br><a href="https://www.cnblogs.com/best/p/5679656.html#_label4" target="_blank" rel="noopener">封装，看了这篇才知道SpringAOP怎么写</a><br><a href="https://blog.csdn.net/luanlouis/article/details/51155821" target="_blank" rel="noopener">参考</a><br><a href="https://my.oschina.net/u/2518341/blog/1806912" target="_blank" rel="noopener">ProxyFactory和ProxyFactoryBean区别</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/15/设计模式/观察者模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="changePosition">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="changePosition">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/15/设计模式/观察者模式/" itemprop="url">观察者模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-15T23:43:05+08:00">
                2017-09-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/设计模式/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h2><blockquote>
<ul>
<li>java.util中的观察者模式很简单，我理解的核心实现就是：接口回调，异步通知，但是要注意一下notifyObservers方法注释中强调的1)，2).</li>
<li>接下来会分析<strong>RxJava</strong></li>
</ul>
</blockquote>
<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><h4 id="被观察者"><a href="#被观察者" class="headerlink" title="被观察者"></a>被观察者</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhangchaoshuai</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/09/13 9:09</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span> 本来想直接new Observable，不继承Observable，</span></span><br><span class="line"><span class="comment"> * 但发现setChanged和clearChanged方法是protected的，</span></span><br><span class="line"><span class="comment"> * 所以只能写个子类在子类里边访问了。难道是打开方式不对？</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyObservable</span> <span class="keyword">extends</span> <span class="title">Observable</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 懒汉式，实现延迟加载</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MyObservable instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyObservable <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> MyObservable();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">emitMsg</span><span class="params">(Object data)</span> </span>&#123;</span><br><span class="line">        setChanged();</span><br><span class="line">        notifyObservers(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用结束，销毁</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance != <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance.deleteObservers();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="观察者"><a href="#观察者" class="headerlink" title="观察者"></a>观察者</h4><ul>
<li>观察者1</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhangchaoshuai</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/09/13 9:10</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span> 观察者1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyObserver01</span> <span class="keyword">implements</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Observable o, Object arg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"MyObserver01"</span> + arg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>观察者2</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhangchaoshuai</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/09/13 9:10</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span> 观察者2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyObserver02</span> <span class="keyword">implements</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ObserverReceiveListener mListener;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyObserver02</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//定义一个回调接口</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyObserver02</span><span class="params">(Observable observable,ObserverReceiveListener listener)</span> </span>&#123;</span><br><span class="line">        observable.addObserver(<span class="keyword">this</span>);</span><br><span class="line">        mListener = listener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Observable o, Object arg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"MyObserver02"</span> + arg);</span><br><span class="line">        mListener.getData(arg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ObserverReceiveListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">getData</span><span class="params">(Object dataReceived)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>测试类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhangchaoshuai</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/09/13 9:11</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestObserver</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        MyObservable observable = MyObservable.getInstance();</span><br><span class="line">        MyObserver01 observer01 = <span class="keyword">new</span> MyObserver01();</span><br><span class="line">        <span class="comment">//另一种写法</span></span><br><span class="line">        MyObserver02 observer02 = <span class="keyword">new</span> MyObserver02(observable, dateReceived -&gt; &#123;</span><br><span class="line">            System.out.println(String.valueOf(<span class="string">"----- "</span> + dateReceived + <span class="string">" -----"</span>));</span><br><span class="line">        &#125;);</span><br><span class="line">        observable.addObserver(observer01);</span><br><span class="line">        observable.addObserver(observer02);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            observable.emitMsg(<span class="string">"data &gt; "</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        observable.destroy();<span class="comment">//销毁观察者</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h3><h4 id="Observable中用到的属性"><a href="#Observable中用到的属性" class="headerlink" title="Observable中用到的属性"></a>Observable中用到的属性</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//observable数据是否改变依靠对这个值的来回设置</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">//存储observer的集合，Vector线程安全的，在存、取、删除等操作时加了锁synchronized</span></span><br><span class="line"><span class="keyword">private</span> Vector&lt;Observer&gt; obs;</span><br></pre></td></tr></table></figure>
<h4 id="核心方法"><a href="#核心方法" class="headerlink" title="核心方法"></a>核心方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//这个方法是由外接observable主动触发的，一般都是在Observable的</span></span><br><span class="line">	<span class="comment">//子类的方法里先setChanged()再notifyObservers</span></span><br><span class="line">    changed = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyObservers</span><span class="params">(Object arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * a temporary array buffer, used as a snapshot of the state of</span></span><br><span class="line"><span class="comment">     * current Observers.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Object[] arrLocal;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        这里直接把英文注释google翻译过来了：</span></span><br><span class="line"><span class="comment">        我们不希望Observer在拥有自己的Monitor时进行任意代码的回调。</span></span><br><span class="line"><span class="comment">        我们从Vector中提取每个Observable并存储Observer状态的代码</span></span><br><span class="line"><span class="comment">        需要同步，但是通知观察者不会（不应该）。这里任何潜在竞争条件</span></span><br><span class="line"><span class="comment">        的最坏结果是：</span></span><br><span class="line"><span class="comment">        1）新添加的观察者将错过正在进行的通知。</span></span><br><span class="line"><span class="comment">        //比如A线程负责通知，B线程负责添加Observer，假如A要通知了，先持有锁，</span></span><br><span class="line"><span class="comment">        //则B只能等A通知后才能持有锁-添加新的observer，那么这个新加的observer肯定接收不到通知。</span></span><br><span class="line"><span class="comment">        2）最近取消注册的观察员在不关心时将被错误地通知。</span></span><br><span class="line"><span class="comment">        //比如A线程负责通知，C线程负责移除Observer，假如A要通知了，先持有锁，</span></span><br><span class="line"><span class="comment">        //则C只能等A通知后才能持有锁-删除Vector中的observer，那么这个本不应该收到通知的Observer</span></span><br><span class="line"><span class="comment">        //会收到不必要的通知！</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (!changed)</span><br><span class="line">	        <span class="comment">//如果数据没发生变化（这个change由外接被观察者自己手动触发）</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        arrLocal = obs.toArray();</span><br><span class="line">        <span class="comment">//清除changed标记</span></span><br><span class="line">        clearChanged();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = arrLocal.length-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--)</span><br><span class="line">	    <span class="comment">//遍历所有的observer，进行通知</span></span><br><span class="line">        ((Observer)arrLocal[i]).update(<span class="keyword">this</span>, arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/14/协议/Https加密流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="changePosition">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="changePosition">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/14/协议/Https加密流程/" itemprop="url">Https加密流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-14T23:43:05+08:00">
                2017-09-14
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/协议/" itemprop="url" rel="index">
                    <span itemprop="name">协议</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Https加密流程"><a href="#Https加密流程" class="headerlink" title="Https加密流程"></a>Https加密流程</h1><h2 id="加密方式"><a href="#加密方式" class="headerlink" title="加密方式"></a>加密方式</h2><blockquote>
<p>加密方式大体分为对称加密、非对称加密两种（简单的摘录一下网上的介绍，便于理解上下文）</p>
</blockquote>
<ol>
<li><p>对称加密算法的优点是<strong>算法公开、计算量小、加密速度快、加密效率高</strong>。对称加密算法的缺点是在数据传送前，发送方和接收方必须商定好秘钥，然后使双方都能保存好秘钥。其次如果一方的秘钥被泄露，那么加密信息也就不安全了。另外，每对用户每次使用对称加密算法时，都需要使用其他人不知道的唯一秘钥，这会使得收、发双方所拥有的钥匙数量巨大，密钥管理成为双方的负担。</p>
</li>
<li><p>非对称加密与对称加密相比，其安全性更好：对称加密的通信双方使用相同的秘钥，如果一方的秘钥遭泄露，那么整个通信就会被破解。而非对称加密使用一对秘钥，一个用来加密，一个用来解密，而且公钥是公开的，私钥是自己保存的，不需要像对称加密那样在通信之前要先同步秘钥。非对称加密的<strong>缺点是加密和解密花费时间长、速度慢，只适合对少量数据进行加密</strong>。</p>
</li>
</ol>
<h2 id="Https采用的加密方式"><a href="#Https采用的加密方式" class="headerlink" title="Https采用的加密方式"></a>Https采用的加密方式</h2><blockquote>
<p>根据上述的优缺点，Https采用了两者结合的方式进行加密。</p>
</blockquote>
<h3 id="只使用非对称加密"><a href="#只使用非对称加密" class="headerlink" title="只使用非对称加密"></a>只使用非对称加密</h3><ul>
<li><p>如何验证server是真的server？<br><img src="/2017/09/14/协议/Https加密流程/./1531019257645.png" alt="Alt text"></p>
</li>
<li><p>上述的单项<strong>认证过程</strong>过程最起码是安全的。</p>
</li>
<li>那么开始正常的数据传输<br><img src="/2017/09/14/协议/Https加密流程/./1531019240418.png" alt="Alt text"></li>
<li>注意上述的传输过程，client和server的身份都确定了，但是存在一个问题就是：server回复的信息可能被第三者截获，虽然第三者无法修改信息（即使修改了也没用，因为没有私钥，无法对修改后的数据进行加密），但它可以解密（因为公钥是公开的）看到信息，这样数据就无法保密了。<blockquote>
<p><strong>实验证明：只用非对称加密是不可靠的，同样从上述非对称加密的缺点来看，它并不适合对大批明文进行加密。</strong></p>
</blockquote>
</li>
</ul>
<h3 id="只使用对称加密"><a href="#只使用对称加密" class="headerlink" title="只使用对称加密"></a>只使用对称加密</h3><blockquote>
<ol>
<li>对称的话，秘钥是保密的，所以（只要不泄露）肯定能保证安全。</li>
<li>那么问题来了：server如何把秘钥给client？这岂不又是一个发送信息而又要信息保密的过程？</li>
<li>想一下非对称加密：<br>server—&gt;client不是安全的（信息无法保密）<br>client—&gt;server是安全的（即使被窃取到了，没有私钥也无法解密）</li>
<li>所以可以让<strong>client</strong>生成一个对称秘钥Key，这个Key经非对称加密由client—&gt;server，这样不就行了？<br><img src="/2017/09/14/协议/Https加密流程/./1531021694804.png" alt="Alt text"></li>
</ol>
</blockquote>
<blockquote>
<ol>
<li>因为私钥只有server拥有，因此client可以通过判断对方是否有私钥来判断对方是否是server。</li>
<li>client通过非对称加密的掩护，安全的和server商量好一个对称加密算法和密钥来保证后面通信过程内容的安全。</li>
</ol>
</blockquote>
<hr>
<p>上述看起来已经安全了，但有个问题：非对称加密确实保证了对称加密的秘钥的安全传输，那么谁来保证非对称加密的公钥的安全传输呢？</p>
<ol>
<li>？？？非对称加密的公钥不是公开的吗？<br>公钥是公开的，那么server如何把公钥发给client呢？</li>
</ol>
<ul>
<li>把公钥放到互联网的某个地方的一个下载地址，事先给client去下载。</li>
<li>每次和client开始通信时，“服务器”把公钥发给server。</li>
</ul>
<ol start="2">
<li>对于方法1，client无法确定这个下载地址是不是server发布的，可能是第三者自己生成的Public，然后伪造的假的地址。<br>对于方法2，也有问题，因为第三者也可以自己生成一对Public和Private，他只要向client发送他自己的Public就可以冒充Server了（<strong>这样的话，相当于后期的所有操作都是在和假的server做交互</strong>）。</li>
</ol>
<h3 id="使用数字证书保证公钥的安全"><a href="#使用数字证书保证公钥的安全" class="headerlink" title="使用数字证书保证公钥的安全"></a>使用数字证书保证公钥的安全</h3><blockquote>
<ol>
<li>为了解决上述【大家都可以生成公钥、私钥对，无法确认公钥对到底是谁的】的这个问题，出现了数字证书。</li>
<li>那也就是说：数字证书可以保证数字证书里的公钥确实是这个证书的所有者(Subject)的，或者证书可以用来确认对方的身份。</li>
</ol>
</blockquote>
<p><img src="/2017/09/14/协议/Https加密流程/./1563795189720.png" alt="Alt text"></p>
<blockquote>
<p>上述的数字证书发给client后：</p>
<ol>
<li>client根据本地<strong>CA的公钥</strong>对数字签名解密，得到A</li>
<li>把公钥等信息进行hash得到B</li>
<li>对比A和B是否相等，相等说明没人篡改。</li>
</ol>
</blockquote>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p><img src="/2017/09/14/协议/Https加密流程/./1563794147322.png" alt="Alt text"></p>
<ul>
<li>为什么是三个随机数？<blockquote>
<p>客户端产生一个Random1、服务端产生一个Random2，但1、2可能是伪随机数，这样的话可能就能猜出加密算法，所以再给一个随机数Premaster secret，这次是真正的”随机数”，是由SSL协议自己产生的。</p>
</blockquote>
</li>
</ul>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://www.cnblogs.com/JeffreySun/archive/2010/06/24/1627247.html" target="_blank" rel="noopener">数字证书原理</a><br><a href="https://mp.weixin.qq.com/s?__biz=MzA5MzI3NjE2MA==&amp;mid=2650242840&amp;idx=1&amp;sn=8c0baf32761c3caca218a5b33b07a1c1&amp;chksm=88638e77bf140761aa0e63a4be3429a017317e700743ccd8e498ef959bb71265bd95a7500398&amp;mpshare=1&amp;scene=1&amp;srcid=0707HrykBg05naCQGiwIaARl#rd" target="_blank" rel="noopener">关于Https那些事</a><br><a href="https://mp.weixin.qq.com/s?__biz=MzI0MjE3OTYwMg==&amp;mid=2649551508&amp;idx=1&amp;sn=74400e80ac0aa575b11604876bd70b1a&amp;chksm=f11819e9c66f90ffc5dfa9c3e7ed761a94a3fcd1b3a20906818f05e5c888fe7211343cb53232&amp;mpshare=1&amp;scene=1&amp;srcid=0503BGQGXsNLVUwAMuJRLL3z#" target="_blank" rel="noopener">也许，这样理解HTTPS更容易</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">changePosition</p>
              <p class="site-description motion-element" itemprop="description">知识体系树</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">changePosition</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
